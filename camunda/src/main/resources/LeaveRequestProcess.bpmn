<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd" targetNamespace="http://www.activiti.org/test">
  <message id="RefineRequest" name="RefineRequest"/>
  <collaboration id="Collaboration">
    <participant id="pool1" name="Request for Leave Process" processRef="HR_RequestForLeave_RequestForLeave"/>
  </collaboration>
  <process id="HR_RequestForLeave_RequestForLeave" name="RequestForLeave" isExecutable="true">
    <laneSet id="laneSet_HR_RequestForLeave_RequestForLeave">
      <lane id="RequesterLane" name="Requester">
        <flowNodeRef>ProcessStartevent</flowNodeRef>
        <flowNodeRef>exclusivegateway2</flowNodeRef>
        <flowNodeRef>Requester</flowNodeRef>
      </lane>
      <lane id="ApproverLane" name="Approver">
        <flowNodeRef>ProcessEndevent</flowNodeRef>
        <flowNodeRef>Approver</flowNodeRef>
        <flowNodeRef>Exclusivegateway</flowNodeRef>
      </lane>
      <lane id="BackEndLane" name="HR System">
        <flowNodeRef>COMMIT_LEAVETIME</flowNodeRef>
        <flowNodeRef>LeaveTimeReachedTimer</flowNodeRef>
        <flowNodeRef>RefineRequestMessage</flowNodeRef>
        <flowNodeRef>PURGE_LEAVETIME</flowNodeRef>
        <flowNodeRef>Eventgateway</flowNodeRef>
        <flowNodeRef>REPORT_LEAVETIME</flowNodeRef>
      </lane>
    </laneSet>
    <endEvent id="ProcessEndevent" name="End">
      <incoming>flow9</incoming>
      <incoming>cancel</incoming>
    </endEvent>
    <serviceTask id="COMMIT_LEAVETIME" activiti:class="de.agito.cps.process.camunda.listener.ExecuteBPMOActionDelegate" name="Commit leave time">
      <extensionElements>
        <activiti:field name="action">
          <activiti:string>COMMIT_LEAVE_TIME</activiti:string>
        </activiti:field>
      </extensionElements>
      <incoming>flow8</incoming>
      <outgoing>flow9</outgoing>
    </serviceTask>
    <sequenceFlow id="flow9" sourceRef="COMMIT_LEAVETIME" targetRef="ProcessEndevent"/>
    <intermediateCatchEvent id="LeaveTimeReachedTimer" name="LeaveTimeReached">
      <documentation>Wait for leave time begining</documentation>
      <incoming>flow7</incoming>
      <outgoing>flow8</outgoing>
      <timerEventDefinition>
        <timeDate xsi:type="tFormalExpression">${LeaveFrom}</timeDate>
      </timerEventDefinition>
    </intermediateCatchEvent>
    <sequenceFlow id="flow8" sourceRef="LeaveTimeReachedTimer" targetRef="COMMIT_LEAVETIME"/>
    <intermediateCatchEvent id="RefineRequestMessage" name="RefineRequest">
      <incoming>flow12</incoming>
      <outgoing>flow16</outgoing>
      <messageEventDefinition messageRef="RefineRequest"/>
    </intermediateCatchEvent>
    <sequenceFlow id="flow16" sourceRef="RefineRequestMessage" targetRef="PURGE_LEAVETIME"/>
    <serviceTask id="PURGE_LEAVETIME" activiti:class="de.agito.cps.process.camunda.listener.ExecuteBPMOActionDelegate" name="Purge leave time">
      <extensionElements>
        <activiti:field name="action">
          <activiti:string>PURGE_LEAVETIME</activiti:string>
        </activiti:field>
      </extensionElements>
      <incoming>flow16</incoming>
      <outgoing>flow15</outgoing>
    </serviceTask>
    <sequenceFlow id="flow15" sourceRef="PURGE_LEAVETIME" targetRef="Requester"/>
    <eventBasedGateway id="Eventgateway" name="Event Gateway">
      <incoming>flow6</incoming>
      <outgoing>flow7</outgoing>
      <outgoing>flow12</outgoing>
    </eventBasedGateway>
    <sequenceFlow id="flow7" sourceRef="Eventgateway" targetRef="LeaveTimeReachedTimer"/>
    <sequenceFlow id="flow12" sourceRef="Eventgateway" targetRef="RefineRequestMessage"/>
    <userTask id="Approver" activiti:exclusive="false" activiti:candidateUsers="${$cpsInitiator}" activiti:candidateGroups="roleAnyone" name="Approve Request">
      <incoming>repeat</incoming>
      <incoming>flow5</incoming>
      <outgoing>flow2</outgoing>
    </userTask>
    <sequenceFlow id="flow2" sourceRef="Approver" targetRef="Exclusivegateway"/>
    <startEvent id="ProcessStartevent" name="Start">
      <outgoing>flow5</outgoing>
    </startEvent>
    <sequenceFlow id="flow5" sourceRef="ProcessStartevent" targetRef="Approver"/>
    <exclusiveGateway id="exclusivegateway2" name="Decision" default="repeat">
      <incoming>flow4</incoming>
      <outgoing>cancel</outgoing>
      <outgoing>repeat</outgoing>
    </exclusiveGateway>
    <sequenceFlow id="cancel" name="cancel" sourceRef="exclusivegateway2" targetRef="ProcessEndevent">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${$cpsChoiceIdRequester.equals("CANCEL")}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="repeat" name="repeat" sourceRef="exclusivegateway2" targetRef="Approver"/>
    <userTask id="Requester" activiti:assignee="${$cpsInitiator}" activiti:candidateUsers="${$cpsInitiator}" name="Refine Request">
      <incoming>flow15</incoming>
      <incoming>notApproved</incoming>
      <outgoing>flow4</outgoing>
    </userTask>
    <sequenceFlow id="flow4" sourceRef="Requester" targetRef="exclusivegateway2"/>
    <exclusiveGateway id="Exclusivegateway" name="Is appoved" default="approved">
      <incoming>flow2</incoming>
      <outgoing>notApproved</outgoing>
      <outgoing>approved</outgoing>
    </exclusiveGateway>
    <sequenceFlow id="notApproved" name="no" sourceRef="Exclusivegateway" targetRef="Requester">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${$cpsChoiceIdApprover.equals("NOT_APPROVED")}]]></conditionExpression>
    </sequenceFlow>
    <sequenceFlow id="approved" name="yes" sourceRef="Exclusivegateway" targetRef="REPORT_LEAVETIME"/>
    <serviceTask id="REPORT_LEAVETIME" activiti:async="true" activiti:exclusive="false" activiti:class="de.agito.cps.process.camunda.listener.ExecuteBPMOActionDelegate" name="Report leave time">
      <extensionElements>
        <activiti:field name="action">
          <activiti:string>REPORT_LEAVE_TIME</activiti:string>
        </activiti:field>
        <activiti:field name="variable">
          <activiti:string>LeaveFrom</activiti:string>
        </activiti:field>
      </extensionElements>
      <incoming>approved</incoming>
      <outgoing>flow6</outgoing>
    </serviceTask>
    <sequenceFlow id="flow6" sourceRef="REPORT_LEAVETIME" targetRef="Eventgateway"/>
    <textAnnotation id="textannotation1">
      <text>fire on leave time start</text>
    </textAnnotation>
    <association id="Association_1" sourceRef="textannotation1" targetRef="LeaveTimeReachedTimer"/>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_Collaboration">
    <bpmndi:BPMNPlane id="BPMNPlane_Collaboration" bpmnElement="Collaboration">
      <bpmndi:BPMNShape id="BPMNShape_pool1" bpmnElement="pool1" isHorizontal="false">
        <omgdc:Bounds height="611.0" width="841.0" x="10.0" y="0.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_RequesterLane" bpmnElement="RequesterLane" isHorizontal="false">
        <omgdc:Bounds height="172.0" width="811.0" x="40.0" y="0.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_ApproverLane" bpmnElement="ApproverLane" isHorizontal="false">
        <omgdc:Bounds height="150.0" width="811.0" x="40.0" y="171.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_BackEndLane" bpmnElement="BackEndLane" isHorizontal="false">
        <omgdc:Bounds height="291.0" width="811.0" x="40.0" y="320.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_ProcessStartevent" bpmnElement="ProcessStartevent">
        <omgdc:Bounds height="35.0" width="35.0" x="70.0" y="82.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="34.0" x="71.0" y="62.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_Approver" bpmnElement="Approver">
        <omgdc:Bounds height="55.0" width="105.0" x="132.0" y="211.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_Exclusivegateway" bpmnElement="Exclusivegateway">
        <omgdc:Bounds height="40.0" width="40.0" x="300.0" y="218.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="67.0" x="340.0" y="228.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_Requester" bpmnElement="Requester">
        <omgdc:Bounds height="55.0" width="105.0" x="268.0" y="96.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_exclusivegateway2" bpmnElement="exclusivegateway2">
        <omgdc:Bounds height="40.0" width="40.0" x="300.0" y="24.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="60.0" x="300.0" y="4.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_ProcessEndevent" bpmnElement="ProcessEndevent">
        <omgdc:Bounds height="35.0" width="35.0" x="754.0" y="221.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="29.0" x="720.0" y="228.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_REPORT_LEAVETIME" bpmnElement="REPORT_LEAVETIME">
        <omgdc:Bounds height="55.0" width="105.0" x="264.0" y="490.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_Eventgateway" bpmnElement="Eventgateway">
        <omgdc:Bounds height="40.0" width="40.0" x="429.0" y="497.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="93.0" x="404.0" y="544.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_LeaveTimeReachedTimer" bpmnElement="LeaveTimeReachedTimer">
        <omgdc:Bounds height="35.0" width="35.0" x="540.0" y="500.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="118.0" x="499.0" y="477.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_COMMIT_LEAVETIME" bpmnElement="COMMIT_LEAVETIME">
        <omgdc:Bounds height="55.0" width="105.0" x="624.0" y="490.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_RefineRequestMessage" bpmnElement="RefineRequestMessage">
        <omgdc:Bounds height="35.0" width="35.0" x="432.0" y="418.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="90.0" x="341.0" y="425.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_PURGE_LEAVETIME" bpmnElement="PURGE_LEAVETIME">
        <omgdc:Bounds height="55.0" width="105.0" x="397.0" y="332.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_textannotation1" bpmnElement="textannotation1">
        <omgdc:Bounds height="30.0" width="157.0" x="612.0" y="564.0"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="BPMNEdge_flow2" bpmnElement="flow2">
        <omgdi:waypoint xsi:type="omgdc:Point" x="236.0" y="238.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="300.0" y="238.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="254.0" y="238.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_notApproved" bpmnElement="notApproved">
        <omgdi:waypoint xsi:type="omgdc:Point" x="320.0" y="218.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="320.0" y="150.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="20.0" x="300.0" y="180.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow4" bpmnElement="flow4">
        <omgdi:waypoint xsi:type="omgdc:Point" x="320.0" y="96.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="320.0" y="64.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="320.0" y="86.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_cancel" bpmnElement="cancel">
        <omgdi:waypoint xsi:type="omgdc:Point" x="340.0" y="44.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="771.0" y="44.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="771.0" y="221.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="44.0" x="372.0" y="44.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_repeat" bpmnElement="repeat">
        <omgdi:waypoint xsi:type="omgdc:Point" x="300.0" y="44.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="184.0" y="44.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="184.0" y="211.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="42.0" x="220.0" y="44.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_approved" bpmnElement="approved">
        <omgdi:waypoint xsi:type="omgdc:Point" x="320.0" y="258.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="316.0" y="490.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="22.0" width="27.0" x="288.0" y="360.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow5" bpmnElement="flow5">
        <omgdi:waypoint xsi:type="omgdc:Point" x="87.0" y="116.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="87.0" y="238.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="132.0" y="238.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="87.0" y="183.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow6" bpmnElement="flow6">
        <omgdi:waypoint xsi:type="omgdc:Point" x="368.0" y="517.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="429.0" y="517.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="396.0" y="517.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow7" bpmnElement="flow7">
        <omgdi:waypoint xsi:type="omgdc:Point" x="469.0" y="517.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="540.0" y="517.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="489.0" y="517.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow8" bpmnElement="flow8">
        <omgdi:waypoint xsi:type="omgdc:Point" x="574.0" y="517.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="624.0" y="517.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="602.0" y="517.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow9" bpmnElement="flow9">
        <omgdi:waypoint xsi:type="omgdc:Point" x="728.0" y="517.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="771.0" y="517.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="771.0" y="255.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="771.0" y="398.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow12" bpmnElement="flow12">
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="497.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="452.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="449.0" y="486.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow15" bpmnElement="flow15">
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="332.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="124.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="372.0" y="123.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="449.0" y="178.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_flow16" bpmnElement="flow16">
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="418.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="449.0" y="386.0"/>
        <bpmndi:BPMNLabel>
          <omgdc:Bounds height="0.0" width="0.0" x="449.0" y="400.0"/>
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_Association_1" bpmnElement="Association_1" sourceElement="BPMNShape_textannotation1" targetElement="BPMNShape_LeaveTimeReachedTimer">
        <omgdi:waypoint xsi:type="omgdc:Point" x="658.0" y="564.0"/>
        <omgdi:waypoint xsi:type="omgdc:Point" x="574.0" y="525.0"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>